#!/usr/bin/env bash
set -e
# Exit immediately if any command fails (fail fast)

# -------------------------
# DRY-RUN SUPPORT
# -------------------------
dry_run="0"
[[ "$1" == "--dry" ]] && dry_run="1"

log() {
    # Prefix output when in dry-run mode
    [[ "$dry_run" == "1" ]] && echo "[DRY_RUN] $*" || echo "$*"
}

# -------------------------
# PATH / ENV SETUP
# -------------------------

# Use XDG_CONFIG_HOME if set, otherwise fallback to ~/.config
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"

# Resolve absolute path of this script
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# DEV_ENV is the root of your repo
DEV_ENV="${DEV_ENV:-$script_dir}"
export DEV_ENV

log "DEV_ENV = $DEV_ENV"
log "XDG_CONFIG_HOME = $XDG_CONFIG_HOME"

# -------------------------
# SYNC A DIRECTORY TREE
# -------------------------
# Copies each top-level folder from:
#   src/foo → dst/foo
# Removes destination first (idempotent)
# -------------------------
sync_tree() {
    local src="$1"
    local dst="$2"

    log "Syncing $src → $dst"

    # Ensure destination exists
    mkdir -p "$dst"

    # IMPORTANT:
    # - dotglob  → include hidden files/folders
    # - nullglob → if no matches, expand to nothing (not literal '*')
    shopt -s dotglob nullglob

    for item in "$src"/*; do
        local name="$(basename "$item")"
        local target="$dst/$name"

        log "  rm -rf $target"
        [[ "$dry_run" == "0" ]] && rm -rf "$target"

        log "  copy $item → $dst"
        [[ "$dry_run" == "0" ]] && cp -a "$item" "$dst/"
    done

    # Restore shell options (VERY IMPORTANT)
    shopt -u dotglob nullglob
}

# -------------------------
# COPY A SINGLE FILE
# -------------------------
copy_file() {
    local src="$1"
    local dst="$2"

    log "Copy $src → $dst"

    # Ensure parent directory exists
    mkdir -p "$(dirname "$dst")"

    [[ "$dry_run" == "0" ]] && cp -f "$src" "$dst"
}

# -------------------------
# EXECUTION
# -------------------------

# Sync ~/.config/*
sync_tree "$DEV_ENV/env/.config" "$XDG_CONFIG_HOME"

# Sync ~/.local/*
sync_tree "$DEV_ENV/env/.local" "$HOME/.local"

# Copy shell & profile files
copy_file "$DEV_ENV/env/.zsh_profile" "$HOME/.zsh_profile"
copy_file "$DEV_ENV/env/.zshrc"        "$HOME/.zshrc"
copy_file "$DEV_ENV/env/.xprofile"     "$HOME/.xprofile"
copy_file "$DEV_ENV/env/.tmux.conf"     "$HOME/.tmux.conf"

# Install dev-env helper script
copy_file "$DEV_ENV/dev-env" "$HOME/.local/scripts/dev-env"

