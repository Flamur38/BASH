#!/usr/bin/env bash
set -e

dry_run="0"

[[ "$1" == "--dry" ]] && dry_run="1"

log() {
    [[ $dry_run == "1" ]] && echo "[DRY_RUN] $*" || echo "$*"
}

XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEV_ENV="${DEV_ENV:-$script_dir}"
export DEV_ENV

log "DEV_ENV = $DEV_ENV"
log "XDG_CONFIG_HOME = $XDG_CONFIG_HOME"

sync_tree() {
    local src="$1"
    local dst="$2"

    log "Syncing $src → $dst"
    mkdir -p "$dst"

    for item in "$src"/*; do
        local name="$(basename "$item")"
        local target="$dst/$name"

        log "  rm -rf $target"
        [[ $dry_run == "0" ]] && rm -rf "$target"

        log "  copy $item → $dst"
        [[ $dry_run == "0" ]] && cp -a "$item" "$dst/"
    done
}

copy_file() {
    local src="$1"
    local dst="$2"

    log "Copy $src → $dst"
    mkdir -p "$(dirname "$dst")"
    [[ $dry_run == "0" ]] && cp -f "$src" "$dst"
}

sync_tree "$DEV_ENV/env/.config" "$XDG_CONFIG_HOME"
sync_tree "$DEV_ENV/env/.local" "$HOME/.local"

copy_file "$DEV_ENV/env/.zsh_profile" "$HOME/.zsh_profile"
copy_file "$DEV_ENV/env/.zshrc" "$HOME/.zshrc"
copy_file "$DEV_ENV/env/.xprofile" "$HOME/.xprofile"
copy_file "$DEV_ENV/dev-env" "$HOME/.local/scripts/dev-env"
