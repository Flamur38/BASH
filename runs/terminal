#!/usr/bin/env bash
set -e

# ==========================================
# GNOME Terminal (Flamy + Incident profiles)
# ==========================================

log() {
  echo "[gnome-terminal] $1"
}

# Detect real user (important when running with sudo)
REAL_USER="${SUDO_USER:-$USER}"
REAL_HOME="$(getent passwd "$REAL_USER" | cut -d: -f6)"

FLAMY_UUID="b1e3e5d0-ffaf-4b77-9a44-7f9c3b0a7f10"
INCIDENT_UUID="c7d9f0f2-9c33-4c3e-9b63-3f63a3c55c44"

# ------------------------------------------
# Resolve repo paths
# ------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
CONF_DIR="$REPO_ROOT/env/.config/terminal"

# ------------------------------------------
# Sanity check profile files
# ------------------------------------------
[[ -f "$CONF_DIR/flamy-profile.conf" ]] || { echo "[!] Missing $CONF_DIR/flamy-profile.conf"; exit 1; }
[[ -f "$CONF_DIR/incident-profile.conf" ]] || { echo "[!] Missing $CONF_DIR/incident-profile.conf"; exit 1; }

# ------------------------------------------
# Install packages
# ------------------------------------------
log "Installing GNOME Terminal, fonts, and dbus-x11"
sudo apt update
sudo apt install -y \
  gnome-terminal \
  fonts-jetbrains-mono \
  fonts-hack \
  dbus-x11

# ------------------------------------------
# Ensure ~/.config exists
# ------------------------------------------
log "Ensuring ~/.config exists"
sudo -u "$REAL_USER" mkdir -p "$REAL_HOME/.config"
sudo chown "$REAL_USER:$REAL_USER" "$REAL_HOME/.config"

# ------------------------------------------
# Register GNOME Terminal profiles
# ------------------------------------------
log "Registering GNOME Terminal profiles"
sudo -u "$REAL_USER" \
  HOME="$REAL_HOME" USER="$REAL_USER" \
  dbus-launch dconf write \
  /org/gnome/terminal/legacy/profiles:/list \
  "[ '$FLAMY_UUID', '$INCIDENT_UUID' ]"

# ------------------------------------------
# Set default profile (flamy)
# ------------------------------------------
log "Setting flamy as default profile"
sudo -u "$REAL_USER" \
  HOME="$REAL_HOME" USER="$REAL_USER" \
  dbus-launch dconf write \
  /org/gnome/terminal/legacy/profiles:/default \
  "'$FLAMY_UUID'"

# ------------------------------------------
# Load profile configs
# ------------------------------------------
log "Loading flamy profile"
sudo -u "$REAL_USER" \
  HOME="$REAL_HOME" USER="$REAL_USER" \
  dbus-launch dconf load \
  "/org/gnome/terminal/legacy/profiles:/:$FLAMY_UUID/" \
  < "$CONF_DIR/flamy-profile.conf"

log "Loading incident profile"
sudo -u "$REAL_USER" \
  HOME="$REAL_HOME" USER="$REAL_USER" \
  dbus-launch dconf load \
  "/org/gnome/terminal/legacy/profiles:/:$INCIDENT_UUID/" \
  < "$CONF_DIR/incident-profile.conf"

# ------------------------------------------
# Set Hack as default font for flamy profile
# ------------------------------------------
log "Setting Hack as default terminal font"
sudo -u "$REAL_USER" \
  HOME="$REAL_HOME" USER="$REAL_USER" \
  dbus-launch dconf write \
  "/org/gnome/terminal/legacy/profiles:/:$FLAMY_UUID/font" \
  "'Hack 15'"

sudo -u "$REAL_USER" \
  HOME="$REAL_HOME" USER="$REAL_USER" \
  dbus-launch dconf write \
  "/org/gnome/terminal/legacy/profiles:/:$FLAMY_UUID/use-system-font" \
  "false"

log "GNOME Terminal setup completed"

