#!/usr/bin/env bash
set -e

log() { echo "[neovim] $1"; }

log "Installing build dependencies"
sudo apt update
sudo apt install -y \
  ninja-build gettext cmake unzip curl build-essential git \
  lua5.1 liblua5.1-0-dev python3 python3-pip cargo \
  ripgrep fd-find nodejs npm

# fd symlink (idempotent)
mkdir -p "$HOME/.local/bin"
ln -sf "$(command -v fdfind)" "$HOME/.local/bin/fd"

NVIM_SRC="$HOME/.local/src/neovim"

if [ ! -d "$NVIM_SRC" ]; then
  log "Cloning Neovim repository"
  git clone https://github.com/neovim/neovim.git "$NVIM_SRC"
fi

cd "$NVIM_SRC"

log "Fetching latest Neovim (master)"
git fetch origin
git checkout master

log "Building Neovim"
make distclean || true
make CMAKE_BUILD_TYPE=Release

log "Installing Neovim to /usr/local"
sudo make install

log "Installed Neovim version:"
nvim --version | head -n1

log "Syncing plugins (Lazy.nvim)"
nvim --headless "+Lazy! sync" +qa || true

# #!/usr/bin/env bash
#
# #!/usr/bin/env bash
#
# if [ -f /etc/apt/sources.list.d/spotify.list ]; then
#   sudo sed -i 's|^deb .*spotify.com.*|#&|' /etc/apt/sources.list.d/spotify.list
# fi
#
#
# sudo apt update
# sudo add-apt-repository ppa:neovim-ppa/unstable -y
# sudo apt update && sudo apt install -y \
#   neovim ninja-build gettext cmake unzip curl build-essential git \
#   lua5.1 liblua5.1-0-dev python3 python3-pip cargo \
#   ripgrep fd-find nodejs npm
#
# # Link fd-find as fd
# mkdir -p ~/.local/bin
# ln -sf "$(which fdfind)" ~/.local/bin/fd
#
# # Add ~/.local/bin to PATH (Zsh only, as requested)
# echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc
# export PATH="$HOME/.local/bin:$PATH"
#
#
# nvim --headless "+Lazy! sync" +qa
#
