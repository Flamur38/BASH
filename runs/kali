#!/usr/bin/env bash
set -e

log() {
  echo "[kali-docker] $1"
}

# --------------------------------
# Check Docker (non-fatal)
# --------------------------------
if ! docker info >/dev/null 2>&1; then
  echo "[kali-docker] Docker not accessible"
  echo "[kali-docker] Hint: log out & log back in, or run: newgrp docker"
  echo "[kali-docker] Skipping Kali setup for now"
  exit 0
fi

# --------------------------------
# Pull Kali Linux image
# --------------------------------
log "Pulling Kali Linux rolling image"
docker pull kalilinux/kali-rolling

# --------------------------------
# Create persistent Kali volume
# --------------------------------
log "Creating persistent volume (kali-home)"
docker volume create kali-home >/dev/null

# --------------------------------
# Optional: preinstall common tools in image
# (one-time build)
# --------------------------------
log "Building Kali pentest image with common tools"

cat <<'EOF' > /tmp/Dockerfile.kali
FROM kalilinux/kali-rolling

RUN apt update && \
    apt install -y \
      crackmapexec \
      netexec \
      impacket-scripts \
      bloodhound \
      python3 \
      git \
      vim \
      tmux \
    && apt clean

WORKDIR /work
EOF

docker build -t kali-pentest -f /tmp/Dockerfile.kali /tmp
rm -f /tmp/Dockerfile.kali

# --------------------------------
# Wrapper scripts
# --------------------------------
log "Installing wrapper commands"

BIN_DIR="$HOME/.local/bin"
mkdir -p "$BIN_DIR"

# CME wrapper
cat <<'EOF' > "$BIN_DIR/cme"
#!/usr/bin/env bash
docker run --rm -it \
  --network host \
  -v kali-home:/root \
  -v "$PWD:/work" \
  kali-pentest \
  crackmapexec "$@"
EOF

# NetExec wrapper
cat <<'EOF' > "$BIN_DIR/nxc"
#!/usr/bin/env bash
docker run --rm -it \
  --network host \
  -v kali-home:/root \
  -v "$PWD:/work" \
  kali-pentest \
  nxc "$@"
EOF

chmod +x "$BIN_DIR/cme" "$BIN_DIR/nxc"

# --------------------------------
# Done
# --------------------------------
log "Kali Docker setup complete"
log "Try: cme smb -h"
log "Try: nxc smb -h"

